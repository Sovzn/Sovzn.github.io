<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#6200ee"><meta name="author" content="Sovzn"><meta name="copyright" content="Sovzn"><meta name="generator" content="Hexo 5.3.0"><meta name="theme" content="hexo-theme-yun"><title>主从复制 | 大师兄</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.22/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_ed8vp4atwoj.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.20.0/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="shortcut icon" type="image/svg+xml" href="/yun.svg"><link rel="mask-icon" href="/yun.svg" color="#6200ee"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"sovzn.github.io","root":"/","title":"大师兄的小破站","version":"1.3.0","mode":"auto","copycode":true,"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"local_search":{"path":"/search.xml"},"fireworks":{"colors":["102, 167, 221","62, 131, 225","33, 78, 194"]}};
  </script><meta name="description" content="Redis主从复制概念： 主从复制，是指将一台redis服务器的数据，复制到其他redis服务器。前者称为主节点（master&#x2F;leader）,后者称为从节点（slave&#x2F;follower）;数据的复制是单向的，只能由主节点到从节点。Master以写为主，Slave以读为主。  默认情况下，每台redis服务器都是主节点；且一个主节点可以有多个从节点(或没有从节点)，但一个从节点只能有一个主节点。">
<meta property="og:type" content="article">
<meta property="og:title" content="主从复制">
<meta property="og:url" content="http://sovzn.github.io/2021/02/12/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/index.html">
<meta property="og:site_name" content="大师兄">
<meta property="og:description" content="Redis主从复制概念： 主从复制，是指将一台redis服务器的数据，复制到其他redis服务器。前者称为主节点（master&#x2F;leader）,后者称为从节点（slave&#x2F;follower）;数据的复制是单向的，只能由主节点到从节点。Master以写为主，Slave以读为主。  默认情况下，每台redis服务器都是主节点；且一个主节点可以有多个从节点(或没有从节点)，但一个从节点只能有一个主节点。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2021021313172642.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTEwMDk0MA==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210214103712378.png">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210214165359447.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTEwMDk0MA==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==">
<meta property="og:image" content="https://img-blog.csdnimg.cn/2021021417341362.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTEwMDk0MA==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==">
<meta property="og:image" content="https://img-blog.csdnimg.cn/20210215125948736.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTEwMDk0MA==,size_16,color_FFFFFF,t_70">
<meta property="og:image" content="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==">
<meta property="article:published_time" content="2021-02-12T09:00:56.000Z">
<meta property="article:modified_time" content="2021-07-02T07:54:48.092Z">
<meta property="article:author" content="Sovzn">
<meta property="article:tag" content="Redis">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://img-blog.csdnimg.cn/2021021313172642.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTEwMDk0MA==,size_16,color_FFFFFF,t_70"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="Table of Contents"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="Overview"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="Sovzn"><img width="96" loading="lazy" src="/Yun.png" alt="Sovzn"><span class="site-author-status" title="永远相信美好的事情即将发生">😊</span></a><div class="site-author-name"><a href="/about/">Sovzn</a></div><a class="site-name" href="/about/site.html">大师兄</a><sub class="site-subtitle"></sub><div class="site-desciption">我只拥有你的月光,我要把它当作骄阳。</div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="Home"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="Archives"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">83</span></a></div><div class="site-state-item"><a href="/categories/" title="Categories"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">26</span></a></div><div class="site-state-item"><a href="/tags/" title="Tags"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">16</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn" title="文档"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" title="RSS" target="_blank" style="color:orange"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-rss-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="http://wpa.qq.com/msgrd?v=3&amp;uin=&amp;site=qq&amp;menu=yes" title="QQ" target="_blank" style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" title="微博" target="_blank" style="color:#E6162D"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-weibo-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" title="豆瓣" target="_blank" style="color:#007722"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-douban-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" title="网易云音乐" target="_blank" style="color:#C20C0C"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-netease-cloud-music-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" title="知乎" target="_blank" style="color:#0084FF"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-zhihu-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" title="哔哩哔哩" target="_blank" style="color:#FF8EB3"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-bilibili-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" title="Telegram Channel" target="_blank" style="color:#0088CC"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" title="Travelling" target="_blank" style="color:var(--hty-text-color)"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-send-plane-2-line"></use></svg></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/null" title="我的小伙伴们" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-genderless-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Redis%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="toc-number">1.</span> <span class="toc-text">Redis主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5%EF%BC%9A"><span class="toc-number">1.1.</span> <span class="toc-text">概念：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.</span> <span class="toc-text">环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E6%9C%BA%E5%A4%9A%E6%9C%8D%E5%8A%A1%F0%9F%8E%88-%E5%9C%A8%E5%8D%95%E6%9C%BA%E4%B8%8A%E9%80%9A%E8%BF%87%E5%BC%80%E5%90%AF%E5%A4%9A%E4%B8%AAredis%E6%9C%8D%E5%8A%A1%E6%9D%A5%E4%BC%AA%E9%80%A0%E5%A4%9A%E5%8F%B0redis%E6%9C%8D%E5%8A%A1%E5%99%A8%E3%80%82"><span class="toc-number">1.2.1.</span> <span class="toc-text">单机多服务🎈:在单机上通过开启多个redis服务来伪造多台redis服务器。</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%A4%8D%E5%88%B6%E4%B8%89%E4%BB%BD%E5%90%AF%E5%8A%A8%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.复制三份启动文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E4%BF%AE%E6%94%B9%E4%BB%A5%E4%B8%8B%E5%86%85%E5%AE%B9%EF%BC%88%E4%BB%A5redis80-conf%E4%B8%BA%E4%BE%8B%EF%BC%89%EF%BC%9A"><span class="toc-number">1.2.3.</span> <span class="toc-text">2.修改以下内容（以redis80.conf为例）：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E5%90%8C%E6%97%B6%E5%BC%80%E5%90%AF%E4%B8%89%E4%B8%AAredis%E6%9C%8D%E5%8A%A1%EF%BC%9A"><span class="toc-number">1.2.4.</span> <span class="toc-text">3.同时开启三个redis服务：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E%E9%9B%86%E7%BE%A4%E6%90%AD%E5%BB%BA"><span class="toc-number">1.2.5.</span> <span class="toc-text">4.一主二从集群搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%91%BD%E4%BB%A4%EF%BC%88-slaveof%EF%BC%89"><span class="toc-number">1.2.5.1.</span> <span class="toc-text">通过命令（ slaveof）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.2.5.2.</span> <span class="toc-text">通过配置文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BB%86%E8%8A%82%E5%86%85%E5%AE%B9%EF%BC%9A"><span class="toc-number">1.3.</span> <span class="toc-text">细节内容：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.4.</span> <span class="toc-text">哨兵模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A6%82%E5%BF%B5"><span class="toc-number">1.4.0.1.</span> <span class="toc-text">概念</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.0.2.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F%E4%BC%98%E7%BC%BA%E7%82%B9%EF%BC%9A"><span class="toc-number">1.4.0.3.</span> <span class="toc-text">哨兵模式优缺点：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%93%A8%E5%85%B5%E9%85%8D%E7%BD%AE%E6%96%87%E6%A1%88%E8%AF%A6%E8%A7%A3%EF%BC%9A"><span class="toc-number">1.4.0.4.</span> <span class="toc-text">哨兵配置文案详解：</span></a></li></ol></li></ol></li></ol></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="http://Sovzn.github.io/2021/02/12/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="Sovzn"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="大师兄"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">主从复制</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="Created: 2021-02-12 17:00:56" itemprop="dateCreated datePublished" datetime="2021-02-12T17:00:56+08:00">2021-02-12</time><span class="post-meta-divider">-</span><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-2-line"></use></svg></span> <time title="Modified: 2021-07-02 15:54:48" itemprop="dateModified" datetime="2021-07-02T15:54:48+08:00">2021-07-02</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">数据库</span></a></span> > <span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/Redis/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">Redis</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/Redis/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">Redis</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#6200ee;"><h1 id="Redis主从复制"><a href="#Redis主从复制" class="headerlink" title="Redis主从复制"></a>Redis主从复制</h1><h2 id="概念："><a href="#概念：" class="headerlink" title="概念："></a>概念：</h2><p><font color='red'> 主从复制，是指将一台redis服务器的数据，复制到其他redis服务器。前者称为主节点（master/leader）,后者称为从节点（slave/follower）;数据的复制是单向的，<strong>只能由主节点到从节点。Master以写为主，Slave以读为主。</strong> </font></p>
<p><font color='cornflowerblue'><strong>默认情况下，每台redis服务器都是主节点</strong>；且一个主节点可以有多个从节点(或没有从节点)，但一个从节点只能有一个主节点。</font></p>
<p> <img src="https://img-blog.csdnimg.cn/2021021313172642.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTEwMDk0MA==,size_16,color_FFFFFF,t_70" alt="img" loading="lazy"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" loading="lazy"> </p>
<p><strong>主从复制的作用主要包括：</strong></p>
<ul>
<li>数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。</li>
<li>故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。</li>
<li><font color='red'>负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写redis数据时应用连接主节点，读redis数据时应用连接从节点），分担服务器负载；尤其是在写少读多的场景下，通过多个读节点分担读负载，可以大大提高redis的并发量。</font></li>
<li>高可用（集群）基石：除了上述的作用以外，主从复制还是哨兵模式和集群能够实施的基础，因此说主从复制是redis高可用的基础。</li>
</ul>
<p><strong>一般来说，要将Redis运用于工程项目中，只使用一台Redis是万万不的，原因如下：</strong></p>
<ol>
<li><p>从结构上：单个Redis服务器会发生单点故障，并且一台服务器需要处理所有的请求负载，压力较大；</p>
</li>
<li><p>从容量上：单个Redis的内存容量有限，就算一台redis服务器的内存容量是256G，也不能将所有的内存用作Redis的存储内存，一般来说，单台Redis最大使用内存不应该超过20G；</p>
</li>
</ol>
<h2 id="环境配置"><a href="#环境配置" class="headerlink" title="环境配置"></a>环境配置</h2><p>只配置从库，不用配置主库（<font color='cornflowerblue'>因为默认情况下，每台redis服务器都是主节点</font>）！</p>
<p>查看当前服务器库信息如下：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> info replication <span class="token comment">#查看当前库的信息</span>
<span class="token comment"># Replication</span>
role:master     <span class="token comment">#角色 master</span>
connected_slaves:0  <span class="token comment">#连接的从机数</span>
master_replid:02e55856e4daafc3fd702f2c47002edcaa3e4358
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="单机多服务🎈-在单机上通过开启多个redis服务来伪造多台redis服务器。"><a href="#单机多服务🎈-在单机上通过开启多个redis服务来伪造多台redis服务器。" class="headerlink" title="单机多服务🎈:在单机上通过开启多个redis服务来伪造多台redis服务器。"></a><font color='red'>单机多服务🎈:在单机上通过开启多个redis服务来伪造多台redis服务器。</font></h3><h3 id="1-复制三份启动文件"><a href="#1-复制三份启动文件" class="headerlink" title="1.复制三份启动文件"></a>1.复制三份启动文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@shiyaochang sconfig<span class="token punctuation">]</span><span class="token comment"># cp redis.conf redis79.conf</span>
<span class="token punctuation">[</span>root@shiyaochang sconfig<span class="token punctuation">]</span><span class="token comment"># cp redis.conf redis80.conf</span>
<span class="token punctuation">[</span>root@shiyaochang sconfig<span class="token punctuation">]</span><span class="token comment"># cp redis.conf redis81.conf</span>
<span class="token punctuation">[</span>root@shiyaochang sconfig<span class="token punctuation">]</span><span class="token comment"># ls</span>
redis79.conf  redis80.conf  redis81.conf  redis.conf<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="2-修改以下内容（以redis80-conf为例）："><a href="#2-修改以下内容（以redis80-conf为例）：" class="headerlink" title="2.修改以下内容（以redis80.conf为例）："></a>2.修改以下内容（以redis80.conf为例）：</h3><ul>
<li>端口 ：port 6380</li>
<li>pidfile /var/run/redis_6380.pid</li>
<li>logfile “6380.log”</li>
<li>dbfilename dump80.rdb</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@shiyaochang sconfig<span class="token punctuation">]</span><span class="token comment"># vim redis79.conf </span>
<span class="token punctuation">[</span>root@shiyaochang sconfig<span class="token punctuation">]</span><span class="token comment"># vim redis80.conf </span>
<span class="token punctuation">[</span>root@shiyaochang sconfig<span class="token punctuation">]</span><span class="token comment"># vim redis81.conf </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<h3 id="3-同时开启三个redis服务："><a href="#3-同时开启三个redis服务：" class="headerlink" title="3.同时开启三个redis服务："></a>3.同时开启三个redis服务：</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@shiyaochang bin<span class="token punctuation">]</span><span class="token comment"># redis-server sconfig/redis79.conf </span>
<span class="token punctuation">[</span>root@shiyaochang bin<span class="token punctuation">]</span><span class="token comment"># redis-server sconfig/redis80.conf </span>
<span class="token punctuation">[</span>root@shiyaochang bin<span class="token punctuation">]</span><span class="token comment"># redis-server sconfig/redis81.conf </span>
<span class="token punctuation">[</span>root@shiyaochang bin<span class="token punctuation">]</span><span class="token comment"># ps -aux|grep redis  查看发现三个redis服务都已开启</span>
root     <span class="token number">13988</span>  <span class="token number">0.0</span>  <span class="token number">0.1</span> <span class="token number">162380</span>  <span class="token number">2512</span> ?        Ssl  <span class="token number">16</span>:10   <span class="token number">0</span>:00 redis-server *:6379
root     <span class="token number">14006</span>  <span class="token number">0.0</span>  <span class="token number">0.1</span> <span class="token number">162380</span>  <span class="token number">2508</span> ?        Ssl  <span class="token number">16</span>:10   <span class="token number">0</span>:00 redis-server *:6380
root     <span class="token number">14026</span>  <span class="token number">0.0</span>  <span class="token number">0.1</span> <span class="token number">162380</span>  <span class="token number">2512</span> ?        Ssl  <span class="token number">16</span>:10   <span class="token number">0</span>:00 redis-server *:6381
root     <span class="token number">14041</span>  <span class="token number">0.0</span>  <span class="token number">0.0</span> <span class="token number">112816</span>   <span class="token number">976</span> pts/0    R+   <span class="token number">16</span>:10   <span class="token number">0</span>:00 <span class="token function">grep</span> --color<span class="token operator">=</span>auto redis
<span class="token punctuation">[</span>root@shiyaochang bin<span class="token punctuation">]</span><span class="token comment"># ls</span>
<span class="token number">6379</span>.log  <span class="token number">6381</span>.log          mcrypt    redis-benchmark  redis-check-rdb  redis-sentinel  sconfig
<span class="token number">6380</span>.log  libmcrypt-config  mdecrypt  redis-check-aof  redis-cli        redis-server
<span class="token punctuation">[</span>root@shiyaochang bin<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h3 id="4-一主二从集群搭建"><a href="#4-一主二从集群搭建" class="headerlink" title="4.一主二从集群搭建"></a>4.一主二从集群搭建</h3><h4 id="通过命令（-slaveof）"><a href="#通过命令（-slaveof）" class="headerlink" title="通过命令（ slaveof）"></a>通过命令（ slaveof）</h4><p>主机我们使用端口为6379的端口，从机使用端口为6380和6381的服务。</p>
<p><strong>Client窗口1（从机6380）：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@shiyaochang bin<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 6380 #连接端口号为6380的redis服务</span>
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> slaveof <span class="token number">127.0</span>.0.1 <span class="token number">6379</span>    <span class="token comment">##--将当前服务转变为指定服务器的从属服务</span>
OK
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> info replication <span class="token comment">## 查看库信息</span>
<span class="token comment"># Replication</span>
role:slave  <span class="token comment">#角色变为从机</span>
master_host:127.0.0.1 <span class="token comment">#主机ip</span>
master_port:6379      <span class="token comment">#主机服务端口</span>
master_link_status:up
master_last_io_seconds_ago:-1
master_sync_in_progress:0
slave_repl_offset:1
master_link_down_since_seconds:1613205682
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:2100cac94e72661bdc3711ebc5c5ac9aac691649
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><font color='red'>注意：如果 出现master_link_status:down 提示， 显示主机是down的状态，说明主机没有从机挂载。 这可能是因为主机配置了的密码requirepass的原因，需要对从机slave的配置文件（redis6379.conf）进行如下修改：</font></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">masterauth  主机密码   <span class="token comment">#指定主机密码</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<p><strong>Client窗口2（从机6381）：</strong></p>
 <pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@shiyaochang bin<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 6381  #连接端口号为6381的redis服务</span>
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> info replication <span class="token comment">## 查看库信息</span>
<span class="token comment"># Replication</span>
role:master <span class="token comment">#角色 主机</span>
connected_slaves:0
master_replid:dd8bc54994ca8c0c112b9d99d668f34c31cee21f
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> slaveof <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> <span class="token comment">##  ##--将当前服务转变为指定服务器的从属服务</span>
OK
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> info replication <span class="token comment">## 再次查看库信息</span>
<span class="token comment"># Replication</span>
role:slave <span class="token comment">#角色变为从机</span>
master_host:127.0.0.1
master_port:6379
master_link_status:up
master_last_io_seconds_ago:-1
master_sync_in_progress:0
slave_repl_offset:1
master_link_down_since_seconds:1613206237
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:dd8bc54994ca8c0c112b9d99d668f34c31cee21f
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>Client窗口3（主机6379）：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@shiyaochang bin<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 6379  #连接端口号为6379的redis服务</span>
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> info replication <span class="token comment">## 查看库信息</span>
<span class="token comment"># Replication</span>
role:master
connected_slaves:2 <span class="token comment">#连接的从机数</span>
slave0:ip<span class="token operator">=</span><span class="token number">127.0</span>.0.1,port<span class="token operator">=</span><span class="token number">6380</span>,state<span class="token operator">=</span>online,offset<span class="token operator">=</span><span class="token number">126</span>,lag<span class="token operator">=</span><span class="token number">1</span>
slave1:ip<span class="token operator">=</span><span class="token number">127.0</span>.0.1,port<span class="token operator">=</span><span class="token number">6381</span>,state<span class="token operator">=</span>online,offset<span class="token operator">=</span><span class="token number">126</span>,lag<span class="token operator">=</span><span class="token number">1</span>
master_replid:348ec239f98fa46a83fc57b1da9c6347216ec586
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:126
second_repl_offset:-1
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:126
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>注：上面这种配置是通过命令配置的，不能长久有效，如果服务重启，配置就会消失，而通过配置文件配置的主从才是永久有效地。</strong></p>
<h4 id="通过配置文件"><a href="#通过配置文件" class="headerlink" title="通过配置文件"></a>通过配置文件</h4><p>我们只需要将从机的配置文件进行如下修改：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">replicaof  主机ip 端口号
masterauth 主机密码
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<h2 id="细节内容："><a href="#细节内容：" class="headerlink" title="细节内容："></a>细节内容：</h2><p><font color='red'>1.主机可以执行写操作，从机不能写只能读！主机中的所有信息和数据，都会自动被从机保存。</font></p>
<p>如下：</p>
<p><strong>Client窗口3（主机6379）：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> k1 v1 <span class="token comment">#在主机中写入一个值</span>
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p><strong>Client窗口2（从机6381）：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> get k1  <span class="token comment">#在从机中拿到主机写入的值</span>
<span class="token string">"v1"</span>
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span class="token builtin class-name">set</span> k2 v2 <span class="token comment">#当在从机中执行写操作会报错</span>
<span class="token punctuation">(</span>error<span class="token punctuation">)</span> READONLY You can't <span class="token function">write</span> against a <span class="token builtin class-name">read</span> only replica.
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><font color='red'>2.如果主机断开连接，从机依旧是连接到主机的，但是会没有写操作，当主机恢复连接是，从机依旧可以直接获取主机写入的值</font></p>
<p><font color='red'>3.通过命令配置的主从，如果从机重启，从机就会变为主机，若将其再次设置为从机，它会立马获取主机中的的所有数据信息（进行了一次<font color='red'> <strong>全量复制</strong></font>）。</font></p>
<blockquote>
<p>复制原理</p>
</blockquote>
<p>Slave（从节点，从机）刚成功连接到Master（主机）后，就会发送一个sync同步命令，Master接到命令后，启动后台的存盘进程，同时收集所有接收到的用于修改数据集命令，在后台执行完毕之后，master将传送整个数据到slave，完成一次完全同步。</p>
<ul>
<li>全量复制：用于初次复制或其它无法进行部分复制的情况，将主节点中的所有数据都发送给从节点。当数据量过大的时候，会造成很大的网络开销。 </li>
<li>增量复制：master继续将新的所有收集到的修改命令一次传给slave，完成同步，即，主机每进行一次写入操作都会进行一次增量复制，将新增的数据同步给从机。</li>
</ul>
<p>注意：</p>
<p><font color='cornflowerblue'>只要从机重新连接主机，都会进行一次全量复制。</font></p>
<blockquote>
<p>链式主从模型</p>
</blockquote>
<p> <img src="https://img-blog.csdnimg.cn/20210214103712378.png" alt="img" loading="lazy"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" loading="lazy"> </p>
<p>如上连接模型，同样在主机（6779）中进行写操作，在从机（6380/6381）进行读操作。</p>
<p>如果主机master(6379)断开连接，我们可以在从机6380中执行以下命令让其成为主机：</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> slaveof no one
OK<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><font color='red'>执行完这个命令，从机6380就会变成主机</font>，如果主机6379又恢复连接，想让6380变成从机，就得通过命令重新配置。</p>
<h2 id="哨兵模式"><a href="#哨兵模式" class="headerlink" title="哨兵模式"></a>哨兵模式</h2><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p><strong>主从切换的技术</strong>是：当主服务器宕机后，需要手动把一台服务器（从机）切换为主服务器，这需要人工干预，费时费力，还会造成一段时间内服务不可用。这不是一种推荐的方式，更多时候，我们优先考虑哨兵模式。redis2.8开始正式提供了Sentinel（哨兵）架构来解决这个问题。</p>
<p>Sentinel能够在后台监控主机是否故障，如果故障了会<font color='cornflowerblue'>自动切换从库为主库</font>。</p>
<p>哨兵模式是一种特殊的模式，首先redis提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是：<font color='red'>哨兵通过发送指令，等待redis服务器响应，从而监控运行的多个redis实例。</font></p>
<p> <img src="https://img-blog.csdnimg.cn/20210214165359447.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTEwMDk0MA==,size_16,color_FFFFFF,t_70" alt="img" loading="lazy"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" loading="lazy"> </p>
<p>​      <strong>这里的哨兵有两个作用：</strong></p>
<ul>
<li>通过发送命令，让redis服务器返回监控其运行状态，包括服务器和从服务器。</li>
<li>当哨兵检测到服务器宕机后，会自动将slave切换成master，然后通过<strong>发布订阅模式</strong>通知其他服务器，<font color='red'> 修改配置文件</font>，让它们切换主机。</li>
</ul>
<p><strong>然而一个哨兵进程对Redis服务器进行监控，可能会出问题，为此我们可以使用多个哨兵进行监控，各个哨兵之间也会进行监控，这样形成了多哨兵模式，如下：</strong></p>
<p> <img src="https://img-blog.csdnimg.cn/2021021417341362.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTEwMDk0MA==,size_16,color_FFFFFF,t_70" alt="img" loading="lazy"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" loading="lazy"> </p>
<p>假设主服务器宕机，哨兵1先检测到这个结果，系统并不会马上进行failover过程，仅仅是哨兵1主观的认为主服务器不可用，这个现象成为<font color='red'><strong>主观下线</strong></font>。当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行failover[故障转移]操作。切换成功后，就会通过发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为<font color='red'><strong>客观下线。</strong></font></p>
<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p><font color='cornflowerblue'>当前状态：同上采用单机多服务模仿多台redis服务器，一主（6379）二从（6380，6381）</font></p>
<p> <img src="https://img-blog.csdnimg.cn/20210215125948736.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NTEwMDk0MA==,size_16,color_FFFFFF,t_70" alt="img" loading="lazy"><img src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动" loading="lazy"> </p>
<p><strong>1.编写一个简单的哨兵配置文件：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@shiyaochang sconfig<span class="token punctuation">]</span><span class="token comment"># vim  sentinel.conf</span>
<span class="token punctuation">[</span>root@shiyaochang sconfig<span class="token punctuation">]</span><span class="token comment"># ls</span>
redis79.conf  redis80.conf  redis81.conf  redis.conf  sentinel.conf

在配置文件sentinel中输入以下内容，让哨兵监控端口为6379的主节点
sentinel monitor myredis <span class="token number">127.0</span>.0.1  <span class="token number">6379</span>  <span class="token number">1</span>    
sentinel auth-pass mymaster <span class="token number">123456</span>    <span class="token comment">#123456为主节点密码</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>2.启动哨兵:redis-sentinel  配置文件</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@shiyaochang bin<span class="token punctuation">]</span><span class="token comment"># redis-sentinel sconfig/sentinel.conf </span>
<span class="token number">12757</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:24:25.163 <span class="token comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span>
<span class="token number">12757</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:24:25.163 <span class="token comment"># Redis version=6.0.10, bits=64, commit=00000000, modified=0, pid=12757, just started</span>
<span class="token number">12757</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:24:25.163 <span class="token comment"># Configuration loaded</span>
                _._                                                  
           _.-`<span class="token variable"><span class="token variable">`</span>__ <span class="token string">''</span>-._                                             
      _.-<span class="token variable">`</span></span><span class="token variable"><span class="token variable">`</span>    <span class="token variable">`</span></span><span class="token builtin class-name">.</span>  <span class="token variable"><span class="token variable">`</span>_.  <span class="token string">''</span>-._           Redis <span class="token number">6.0</span>.10 <span class="token punctuation">(</span>00000000/0<span class="token punctuation">)</span> <span class="token number">64</span> bit
  .-<span class="token variable">`</span></span><span class="token variable"><span class="token variable">`</span> .-<span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token builtin class-name">.</span>  <span class="token variable">`</span></span>`<span class="token variable"><span class="token variable">`</span><span class="token punctuation">\</span>/    _.,_ <span class="token string">''</span>-._                                   
 <span class="token punctuation">(</span>    '      ,       .-<span class="token variable">`</span></span>  <span class="token operator">|</span> <span class="token variable"><span class="token variable">`</span>,    <span class="token punctuation">)</span>     Running <span class="token keyword">in</span> sentinel mode
 <span class="token operator">|</span><span class="token variable">`</span></span>-._<span class="token variable"><span class="token variable">`</span>-<span class="token punctuation">..</span>.-<span class="token variable">`</span></span> __<span class="token punctuation">..</span>.-.`<span class="token variable"><span class="token variable">`</span>-._<span class="token operator">|</span>'<span class="token variable">`</span></span> _.-<span class="token string">'|     Port: 26379
 |    <span class="token variable"><span class="token variable">`</span>-._   <span class="token variable">`</span></span>._    /     _.-'</span>    <span class="token operator">|</span>     PID: <span class="token number">12757</span>
  <span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-._  <span class="token variable"><span class="token variable">`</span>-./  _.-<span class="token string">'    _.-'</span>                                   
 <span class="token operator">|</span><span class="token variable">`</span></span>-._<span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-.__.-<span class="token string">'    _.-'</span>_.-<span class="token string">'|                                  
 |    <span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-._        _.-'</span>_.-<span class="token string">'    |           http://redis.io        
  <span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-._<span class="token variable"><span class="token variable">`</span>-.__.-<span class="token string">'_.-'</span>    _.-'                                   
 <span class="token operator">|</span><span class="token variable">`</span></span>-._<span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-.__.-'</span>    _.-<span class="token string">'_.-'</span><span class="token operator">|</span>                                  
 <span class="token operator">|</span>    <span class="token variable"><span class="token variable">`</span>-._<span class="token variable">`</span></span>-._        _.-<span class="token string">'_.-'</span>    <span class="token operator">|</span>                                  
  <span class="token variable"><span class="token variable">`</span>-._    <span class="token variable">`</span></span>-._<span class="token variable"><span class="token variable">`</span>-.__.-<span class="token string">'_.-'</span>    _.-'                                   
      <span class="token variable">`</span></span>-._    <span class="token variable"><span class="token variable">`</span>-.__.-<span class="token string">'    _.-'</span>                                       
          <span class="token variable">`</span></span>-._        _.-<span class="token string">'                                           
              `-.__.-'</span>                                               

<span class="token number">12757</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:24:25.164 <span class="token comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span>
<span class="token number">12757</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:24:25.168 <span class="token comment"># Sentinel ID is ed4d2de017a9b2f364a24c3cd60bb33406aa08b9</span>
<span class="token number">12757</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:24:25.168 <span class="token comment"># +monitor master myredis 127.0.0.1 6379 quorum 1</span>
<span class="token comment">#-------------------------------------检测到哨兵所监控的主机6379的两个从机：--------------------------------</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:46:05.886 * +slave slave <span class="token number">127.0</span>.0.1:6381 <span class="token number">127.0</span>.0.1 <span class="token number">6381</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:46:05.889 * +slave slave <span class="token number">127.0</span>.0.1:6380 <span class="token number">127.0</span>.0.1 <span class="token number">6380</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>3.断开主机（模仿主节点宕机）</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token builtin class-name">set</span> k1 v1
OK
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> <span class="token function">shutdown</span> 
not connected<span class="token operator">></span> <span class="token builtin class-name">exit</span>
<span class="token punctuation">[</span>root@shiyaochang bin<span class="token punctuation">]</span><span class="token comment"># </span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>4.观察哨兵打印出的日志：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:41.462 <span class="token comment"># +sdown master mymaster 127.0.0.1 6379</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:41.462 <span class="token comment"># +odown master mymaster 127.0.0.1 6379 #quorum 1/1</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:41.462 <span class="token comment"># +new-epoch 1</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:41.462 <span class="token comment"># +try-failover master mymaster 127.0.0.1 6379</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:41.465 <span class="token comment"># +vote-for-leader 6e97b389cd0156bda03a54bf8bd316edd36a76c5 1</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:41.465 <span class="token comment"># +elected-leader master mymaster 127.0.0.1 6379</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:41.465 <span class="token comment"># +failover-state-select-slave master mymaster 127.0.0.1 6379</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:41.517 <span class="token comment"># +selected-slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:41.517 * +failover-state-send-slaveof-noone slave <span class="token number">127.0</span>.0.1:6381 <span class="token number">127.0</span>.0.1 <span class="token number">6381</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:41.607 * +failover-state-wait-promotion slave <span class="token number">127.0</span>.0.1:6381 <span class="token number">127.0</span>.0.1 <span class="token number">6381</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:41.614 <span class="token comment"># +promoted-slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6379</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:41.614 <span class="token comment"># +failover-state-reconf-slaves master mymaster 127.0.0.1 6379</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:41.670 * +slave-reconf-sent slave <span class="token number">127.0</span>.0.1:6380 <span class="token number">127.0</span>.0.1 <span class="token number">6380</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:42.643 * +slave-reconf-inprog slave <span class="token number">127.0</span>.0.1:6380 <span class="token number">127.0</span>.0.1 <span class="token number">6380</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:42.643 * +slave-reconf-done slave <span class="token number">127.0</span>.0.1:6380 <span class="token number">127.0</span>.0.1 <span class="token number">6380</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:42.734 <span class="token comment"># +failover-end master mymaster 127.0.0.1 6379</span>
<span class="token comment">#------------------------------如下可见：端口为6381的服务变成主节点------------------------------</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:42.734 <span class="token comment"># +switch-master mymaster 127.0.0.1 6379 127.0.0.1 6381</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:42.734 * +slave slave <span class="token number">127.0</span>.0.1:6380 <span class="token number">127.0</span>.0.1 <span class="token number">6380</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6381</span>
<span class="token comment">#------------------------------端口为6379的服务变成从节点，也就是说当6379重连后，它会变成主节点6380的从节点------------------------------</span>
<span class="token number">15197</span>:X <span class="token number">15</span> Feb <span class="token number">2021</span> <span class="token number">12</span>:48:42.734 * +slave slave <span class="token number">127.0</span>.0.1:6379 <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> @ mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6381</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>5.查看6380和6379的replication信息：</strong></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> info replication
<span class="token comment"># Replication</span>
role:slave  <span class="token comment">#端口号为6380的redis服务任是从节点</span>
master_host:127.0.0.1
master_port:6381 <span class="token comment">#主节点变成6381</span>
master_link_status:up
master_last_io_seconds_ago:1
master_sync_in_progress:0
slave_repl_offset:24980
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:fef5c8cb508a9913e2be4657f4b7662a15f2137b
master_replid2:73db7bbdd747fae5a9c4bbf6411abc0cf2e85fb0
master_repl_offset:24980
second_repl_offset:9061
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:24980
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">0</span>></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> auth <span class="token number">123456</span>
OK
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> info replication
<span class="token comment"># Replication</span>
role:master   <span class="token comment">#6381变成主节点</span>
connected_slaves:1
slave0:ip<span class="token operator">=</span><span class="token number">127.0</span>.0.1,port<span class="token operator">=</span><span class="token number">6380</span>,state<span class="token operator">=</span>online,offset<span class="token operator">=</span><span class="token number">25792</span>,lag<span class="token operator">=</span><span class="token number">1</span> <span class="token comment">#从节点信息</span>
master_replid:fef5c8cb508a9913e2be4657f4b7662a15f2137b
master_replid2:73db7bbdd747fae5a9c4bbf6411abc0cf2e85fb0
master_repl_offset:25925
second_repl_offset:9061
repl_backlog_active:1
repl_backlog_size:1048576
repl_backlog_first_byte_offset:1
repl_backlog_histlen:25925
<span class="token number">127.0</span>.0.1:638<span class="token operator"><span class="token file-descriptor important">1</span>></span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><strong>6.当原来的主节点（6379）恢复连接后：</strong></p>
<p><font color='red'>当原来的主机重连后，它会变为新选的主机的从机</font></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@shiyaochang bin<span class="token punctuation">]</span><span class="token comment"># redis-server sconfig/redis79.conf #重启服务</span>
<span class="token punctuation">[</span>root@shiyaochang bin<span class="token punctuation">]</span><span class="token comment"># redis-cli -p 6379 -a 123456</span>
Warning: Using a password with <span class="token string">'-a'</span> or <span class="token string">'-u'</span> option on the <span class="token builtin class-name">command</span> line interface may not be safe.
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> info replication
<span class="token comment"># Replication</span>
role:slave <span class="token comment">#变为6381的从机</span>
master_host:127.0.0.1
master_port:6381
master_link_status:down
master_last_io_seconds_ago:-1
master_sync_in_progress:0
slave_repl_offset:1
master_link_down_since_seconds:1613365689
slave_priority:100
slave_read_only:1
connected_slaves:0
master_replid:f36898ab95dd599885e49f62ceced4b684c09fa6
master_replid2:0000000000000000000000000000000000000000
master_repl_offset:0
second_repl_offset:-1
repl_backlog_active:0
repl_backlog_size:1048576
repl_backlog_first_byte_offset:0
repl_backlog_histlen:0
<span class="token number">127.0</span>.0.1:637<span class="token operator"><span class="token file-descriptor important">9</span>></span> 
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p><font color='red'> <strong>注意🎈🎈🎈：</strong>哨兵切换主从关系是通过修改redis服务配置文件的方式，所以说，其具有长久性，哨兵切换后的主从关系会一直保持，直至哨兵再次切换主从关系，期间即使服务重启，也不会改变。 </font></p>
<p><font color='red'> 而且如上测试，当主节点发生改变，哨兵配置文件中所监控的主节点信息也会随之改变： </font></p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token punctuation">[</span>root@shiyaochang sconfig<span class="token punctuation">]</span><span class="token comment"># cat sentinel.conf </span>
sentinel myid 6e97b389cd0156bda03a54bf8bd316edd36a76c5
sentinel deny-scripts-reconfig <span class="token function">yes</span>

<span class="token comment"># Generated by CONFIG REWRITE</span>
protected-mode no
port <span class="token number">26379</span>
user default on nopass ~* +@all
<span class="token function">dir</span> <span class="token string">"/usr/local/bin"</span>
sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6381</span> <span class="token number">1</span> <span class="token comment">#哨兵叫监控的主节点变成6381</span>
sentinel auth-pass mymaster <span class="token number">123456</span>
sentinel config-epoch mymaster <span class="token number">1</span>
sentinel leader-epoch mymaster <span class="token number">1</span>
sentinel known-replica mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span>
sentinel known-replica mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6380</span>
sentinel current-epoch <span class="token number">1</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>


<h4 id="哨兵模式优缺点："><a href="#哨兵模式优缺点：" class="headerlink" title="哨兵模式优缺点："></a>哨兵模式优缺点：</h4><p><strong>优点：</strong></p>
<ul>
<li>主动可以切换，故障可以转移，系统有更高的可用性</li>
<li>哨兵模式就是主从模式的升级，手动切换主节点变成自动切换</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>Redis不好在线扩容，集群容量一旦达到上限，在线扩容就十分麻烦。</li>
</ul>
<p><font color='orange'>上述测试只是简单的用哨兵监视了一个主节点，其实哨兵的配置十分复杂，可以监控多个主从节点，以及哨兵之间相互监控。</font></p>
<h4 id="哨兵配置文案详解："><a href="#哨兵配置文案详解：" class="headerlink" title="哨兵配置文案详解："></a>哨兵配置文案详解：</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># Example sentinel.conf</span>
 
<span class="token comment"># 哨兵sentinel实例运行的端口 默认26379</span>
port <span class="token number">26379</span>
 
<span class="token comment"># 哨兵sentinel的工作目录</span>
<span class="token function">dir</span> /tmp
 
<span class="token comment"># 哨兵sentinel监控的redis主节点的 ip port </span>
<span class="token comment"># master-name  可以自己命名的主节点名字 只能由字母A-z、数字0-9 、这三个字符".-_"组成。</span>
<span class="token comment"># quorum 当这些quorum个数sentinel哨兵认为master主节点失联 那么这时 客观上认为主节点失联了</span>
<span class="token comment"># sentinel monitor &lt;master-name> &lt;ip> &lt;redis-port> &lt;quorum></span>
  sentinel monitor mymaster <span class="token number">127.0</span>.0.1 <span class="token number">6379</span> <span class="token number">2</span>
 
<span class="token comment"># 当在Redis实例中开启了requirepass 授权密码 这样所有连接Redis实例的客户端都要提供密码</span>
<span class="token comment"># 设置哨兵sentinel 连接主从的密码 注意必须为主从设置一样的验证密码</span>
<span class="token comment"># sentinel auth-pass &lt;master-name> &lt;password></span>
sentinel auth-pass mymaster <span class="token number">123456</span>
 
 
<span class="token comment"># 指定多少毫秒之后 主节点没有应答哨兵sentinel 此时 哨兵主观上认为主节点下线 默认30秒</span>
<span class="token comment"># sentinel down-after-milliseconds &lt;master-name> &lt;milliseconds></span>
sentinel down-after-milliseconds mymaster <span class="token number">30000</span>
 
<span class="token comment"># 这个配置项指定了在发生failover主备切换时最多可以有多少个slave同时对新的master进行 同步，</span>
这个数字越小，完成failover所需的时间就越长，
但是如果这个数字越大，就意味着越 多的slave因为replication而不可用。
可以通过将这个值设为 <span class="token number">1</span> 来保证每次只有一个slave 处于不能处理命令请求的状态。
<span class="token comment"># sentinel parallel-syncs &lt;master-name> &lt;numslaves></span>
sentinel parallel-syncs mymaster <span class="token number">1</span>
 
 
 
<span class="token comment"># 故障转移的超时时间 failover-timeout 可以用在以下这些方面： </span>
<span class="token comment">#1. 同一个sentinel对同一个master两次failover之间的间隔时间。</span>
<span class="token comment">#2. 当一个slave从一个错误的master那里同步数据开始计算时间。直到slave被纠正为向正确的master那里同步数据时。</span>
<span class="token comment">#3.当想要取消一个正在进行的failover所需要的时间。  </span>
<span class="token comment">#4.当进行failover时，配置所有slaves指向新的master所需的最大时间。不过，即使过了这个超时，slaves依然会被正确配置为指向master，但是就不按parallel-syncs所配置的规则来了</span>
<span class="token comment"># 默认三分钟</span>
<span class="token comment"># sentinel failover-timeout &lt;master-name> &lt;milliseconds></span>
sentinel failover-timeout mymaster <span class="token number">180000</span>
 
<span class="token comment"># SCRIPTS EXECUTION</span>
 
<span class="token comment">#配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知相关人员。</span>
<span class="token comment">#对于脚本的运行结果有以下规则：</span>
<span class="token comment">#若脚本执行后返回1，那么该脚本稍后将会被再次执行，重复次数目前默认为10</span>
<span class="token comment">#若脚本执行后返回2，或者比2更高的一个返回值，脚本将不会重复执行。</span>
<span class="token comment">#如果脚本在执行过程中由于收到系统中断信号被终止了，则同返回值为1时的行为相同。</span>
<span class="token comment">#一个脚本的最大执行时间为60s，如果超过这个时间，脚本将会被一个SIGKILL信号终止，之后重新执行。</span>
 
<span class="token comment">#通知型脚本:当sentinel有任何警告级别的事件发生时（比如说redis实例的主观失效和客观失效等等），将会去调用这个脚本，</span>
这时这个脚本应该通过邮件，SMS等方式去通知系统管理员关于系统不正常运行的信息。调用该脚本时，将传给脚本两个参数，
一个是事件的类型，
一个是事件的描述。
如果sentinel.conf配置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则sentinel无法正常启动成功。
<span class="token comment">#通知脚本</span>
<span class="token comment"># sentinel notification-script &lt;master-name> &lt;script-path></span>
  sentinel notification-script mymaster /var/redis/notify.sh
 
<span class="token comment"># 客户端重新配置主节点参数脚本</span>
<span class="token comment"># 当一个master由于failover而发生改变时，这个脚本将会被调用，通知相关的客户端关于master地址已经发生改变的信息。</span>
<span class="token comment"># 以下参数将会在调用脚本时传给脚本:</span>
<span class="token comment"># &lt;master-name> &lt;role> &lt;state> &lt;from-ip> &lt;from-port> &lt;to-ip> &lt;to-port></span>
<span class="token comment"># 目前&lt;state>总是“failover”,</span>
<span class="token comment"># &lt;role>是“leader”或者“observer”中的一个。 </span>
<span class="token comment"># 参数 from-ip, from-port, to-ip, to-port是用来和旧的master和新的master(即旧的slave)通信的</span>
<span class="token comment"># 这个脚本应该是通用的，能被多次调用，不是针对性的。</span>
<span class="token comment"># sentinel client-reconfig-script &lt;master-name> &lt;script-path></span>
 sentinel client-reconfig-script mymaster /var/redis/reconfig.sh<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</div><div id="reward-container"><span class="hty-icon-button button-glow" id="reward-button" title="Donate" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === &quot;none&quot;) ? &quot;block&quot; : &quot;none&quot;;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-hand-coin-line"></use></svg></span><div id="reward-comment">给个饭钱？</div><div id="qr" style="display:none;"><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://i.loli.net/2020/12/23/J2Sv6rVeLtAPiHx.jpg"><img loading="lazy" src="https://i.loli.net/2020/12/23/J2Sv6rVeLtAPiHx.jpg" alt="支付宝" title="支付宝"></a><div><span style="color:#00A3EE"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-alipay-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://i.loli.net/2020/12/23/4rBXF1deMD6KyN8.png"><img loading="lazy" src="https://i.loli.net/2020/12/23/4rBXF1deMD6KyN8.png" alt="QQ 支付" title="QQ 支付"></a><div><span style="color:#12B7F5"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-qq-line"></use></svg></span></div></div><div style="display:inline-block"><a target="_blank" rel="noopener" href="https://i.loli.net/2020/12/23/XvirFV3o6GyRMZU.png"><img loading="lazy" src="https://i.loli.net/2020/12/23/XvirFV3o6GyRMZU.png" alt="微信支付" title="微信支付"></a><div><span style="color:#2DC100"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-wechat-pay-line"></use></svg></span></div></div></div></div><ul class="post-copyright"><li class="post-copyright-author"><strong>Post author: </strong>Sovzn</li><li class="post-copyright-link"><strong>Post link: </strong><a href="http://sovzn.github.io/2021/02/12/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/" title="主从复制">http://sovzn.github.io/2021/02/12/%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6/</a></li><li class="post-copyright-license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> unless otherwise stated.</li></ul></section></article><div class="post-nav"><div class="post-nav-item"><a class="post-nav-prev" href="/2021/02/15/%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E5%92%8C%E9%9B%AA%E5%B4%A9/" rel="prev" title="缓存穿透和雪崩"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-left-s-line"></use></svg><span class="post-nav-text">缓存穿透和雪崩</span></a></div><div class="post-nav-item"><a class="post-nav-next" href="/2021/02/12/Redis%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85/" rel="next" title="Redis发布订阅"><span class="post-nav-text">Redis发布订阅</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div><div id="comment"><div class="comment-tooltip text-center"><span>点击按钮跳转 GitHub Issues 评论。</span><br><span>若没有本文 Issue，您可以使用 Comment 模版新建。</span><br><a class="hty-button hty-button--raised" id="github-issues" target="_blank" rel="noopener" href="https://github.com/YunYouJun/yunyoujun.github.io/issues?q=is:issue+主从复制">GitHub Issues</a></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 – 2023 </span><span class="with-love" id="animate"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></span><span class="author"> Sovzn</span></div><div class="live_time"><span>本博客已运行</span><span id="display_live_time"></span><span class="moe-text">(●'◡'●)</span><script>function blog_live_time() {
  window.setTimeout(blog_live_time, 1000);
  const start = new Date('2020-04-12T00:00:00');
  const now = new Date();
  const timeDiff = (now.getTime() - start.getTime());
  const msPerMinute = 60 * 1000;
  const msPerHour = 60 * msPerMinute;
  const msPerDay = 24 * msPerHour;
  const passDay = Math.floor(timeDiff / msPerDay);
  const passHour = Math.floor((timeDiff % msPerDay) / 60 / 60 / 1000);
  const passMinute = Math.floor((timeDiff % msPerHour) / 60 / 1000);
  const passSecond = Math.floor((timeDiff % msPerMinute) / 1000);
  display_live_time.innerHTML = " " + passDay + " 天 " + passHour + " 小时 " + passMinute + " 分 " + passSecond + " 秒";
}
blog_live_time();
</script></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#6200ee" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" href="javascript:;" title="Search"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a><script>window.addEventListener("DOMContentLoaded", () => {
  // Handle and trigger popup window
  document.querySelector(".popup-trigger").addEventListener("click", () => {
    document.querySelector(".popup").classList.add("show");
    setTimeout(() => {
      document.querySelector(".search-input").focus();
    }, 100);
  });

  // Monitor main search box
  const onPopupClose = () => {
    document.querySelector(".popup").classList.remove("show");
  };

  document.querySelector(".popup-btn-close").addEventListener("click", () => {
    onPopupClose();
  });

  window.addEventListener("keyup", event => {
    if (event.key === "Escape") {
      onPopupClose();
    }
  });
});
</script><script src="/js/search/local-search.js" defer></script><div class="popup search-popup"><div class="search-header"><span class="popup-btn-close close-icon hty-icon-button"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-close-line"></use></svg></span></div><div class="search-input-container"><input class="search-input" id="local-search-input" type="text" placeholder="Searching..." value=""></div><div id="local-search-result"></div></div></div><script defer src="/js/utils.js"></script><script defer src="/js/hexo-theme-yun.js"></script></body></html>